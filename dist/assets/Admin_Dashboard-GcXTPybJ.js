import{_ as pe,r,w as he,c as A,u as ke,o as ge,a as n,b as e,d as _e,e as fe,f as ye,S as we,g as i,t as l,F as be,h as Ae,i as T,n as q,j as B,k as Te,v as Ce,B as Se,C as X,A as Q,l as Re,J as Pe,m as Me,p as $e,q as o}from"./index-DGMigDkt.js";const Ee={class:"home-page",style:{"--hero-img":"url(/Background.png)"}},Oe={class:"topbar"},xe={class:"container dashboard"},Ie={key:0,class:"summary-grid"},We={class:"summary-card"},Be={class:"value"},De={class:"summary-card"},Le={class:"value"},Ne={class:"summary-card"},qe={class:"value"},Ve={class:"summary-card"},je={class:"value"},Fe={class:"summary-card"},Ge={class:"value"},He={key:1,class:"table-section"},Ue={class:"table-header"},ze=["disabled"],Je={key:0,class:"error"},Ke={key:1,class:"empty"},Xe={key:2,class:"table-wrapper"},Qe={class:"table"},Ye={class:"cell-title"},Ze={class:"title"},et={class:"sub"},tt={class:"mono"},at=["onClick"],st={key:2,class:"promoter-section"},lt={key:0,class:"error"},nt={key:1,class:"promoter-meta"},ot={class:"row"},rt=["href"],it={key:0,class:"row"},ut=["href"],ct={class:"row"},dt=["href"],mt={key:1,class:"mono"},vt=["disabled"],pt={key:1,class:"error"},ht={key:2,class:"hint"},kt={class:"promoter-form"},gt={class:"promoter-actions"},_t=["disabled"],ft=["disabled"],yt=["disabled"],wt={key:0,class:"error"},bt={key:1,class:"ok"},At={key:2,class:"promoter-result"},Tt={class:"row"},Ct=["href"],St={key:0,class:"row"},Rt={key:1,class:"row"},Pt=["href"],Mt={key:3,class:"forbidden"},$="https://amoy.polygonscan.com",$t={__name:"Admin_Dashboard",setup(Et){const Y=Me(),Z=$e(),C=r(!1),ee=()=>C.value=!C.value;he(()=>Y.fullPath,()=>C.value=!1);const{account:c,ensureChain:te}=ke(),S="0xd0c718240519a2a843F2c9d2A8321ADD9caa1F15",ae="https://rpc-amoy.polygon.technology",E=r(""),g=r(""),R=r(null),O=r(!1),d=r(""),P=r(!1),p=r(""),h=r(""),k=r(""),x=r(""),_=r(""),I=r(!1),se=A(()=>c.value?`${$}/address/${c.value}`:""),le=A(()=>g.value?`${$}/address/${g.value}`:""),ne=A(()=>h.value?`${$}/tx/${h.value}`:""),D=A(()=>!k.value||!c.value?!1:String(k.value).toLowerCase()===String(c.value).toLowerCase());function V(a){const t=String(a||"").trim();if(!t)return"";try{return Re(t)}catch{return""}}let W=null;function oe(){return W||(W=new Pe(ae),W)}function j(){return new X(S,Q,oe())}async function re(){_.value="";try{if(!window?.ethereum?.request)return;const a=await window.ethereum.request({method:"eth_accounts"});Array.isArray(a)&&a[0]&&(c.value=a[0])}catch(a){console.warn("syncWalletSilent error:",a)}}async function F(){_.value="",I.value=!0;try{if(!window?.ethereum?.request){_.value="MetaMask tidak terdeteksi. Install/aktifkan MetaMask extension.";return}const a=await window.ethereum.request({method:"eth_requestAccounts"});Array.isArray(a)&&a[0]&&(c.value=a[0])}catch(a){console.error(a),_.value=a?.message||"Gagal connect wallet."}finally{I.value=!1}}async function ie(){x.value="",k.value="";try{const t=await j().owner();k.value=String(t||"")}catch(a){console.error(a),x.value=a?.message||"Gagal mengambil owner kontrak."}}async function G(){d.value="",p.value="",h.value="",R.value=null;const a=V(E.value);if(g.value=a,!a){d.value="Alamat wallet tidak valid.";return}O.value=!0;try{const s=await j().isPromoter(a);R.value=!!s}catch(t){console.error(t),d.value=t?.reason||t?.message||"Gagal memeriksa status promoter."}finally{O.value=!1}}async function H(a){d.value="",p.value="",h.value="";const t=V(E.value);if(g.value=t,!t){d.value="Alamat wallet tidak valid.";return}if(!window?.ethereum?.request){d.value="MetaMask tidak terdeteksi. Untuk menambah/menghapus promoter, Anda harus memakai MetaMask extension.";return}const s=!!a,u=s?"menambahkan":"menghapus";if(window.confirm(`Konfirmasi: ${u} promoter untuk wallet
${t}

Transaksi akan muncul di MetaMask.`)){P.value=!0;try{c.value||await F(),await te("amoy");const b=await new Se(window.ethereum).getSigner(),K=await new X(S,Q,b).setPromoter(t,s);h.value=K?.hash||"",p.value="Transaksi dikirim. Menunggu konfirmasi…",await K.wait(),p.value="Berhasil. Status promoter sudah diperbarui di blockchain.",await G()}catch(v){console.error(v),p.value="",d.value=v?.reason||v?.shortMessage||v?.message||"Transaksi gagal."}finally{P.value=!1}}}function ue(a){a&&Z.push({name:"admin-event-transactions",params:{id:a}})}const ce="http://localhost:3001,https://asiqtix-main-production.up.railway.app/".replace(/\/+$/,"").replace(/\/api$/i,""),de=()=>(localStorage.getItem("walletAddress")||"").toString();async function U(a,t={}){const s=a.startsWith("/api")?a:`/api${a.startsWith("/")?a:`/${a}`}`,u=await fetch(`${ce}${s}`,{...t,headers:{"content-type":"application/json",...t.headers||{},"x-wallet-address":de()}}),m=await u.json().catch(()=>({}));if(!u.ok)throw new Error(m?.error||m?.message||`HTTP ${u.status}`);return m}function L(a){return a?String(Math.round(a)).replace(/\B(?=(\d{3})+(?!\d))/g,"."):""}function me(a){if(!a)return"-";const t=new Date(a);return Number.isFinite(t.getTime())?t.toLocaleString("id-ID",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):a}const f=r("customer"),y=r(!1),w=r(""),z=r([]),N=A(()=>z.value.map(a=>{const t=Number(a.sold_tickets||0),s=Number(a.total_tickets||0),u=Number(a.price_idr||0),m=t*u;return{id:a.id,title:a.title,venue:a.venue,dateLabel:me(a.date_iso),sold:t,total:s,remaining:Math.max(s-t,0),priceIdr:u,revenueIdr:m,listed:!!a.listed,promoterWallet:a.promoter_wallet||null}})),M=A(()=>{const a=N.value,t=a.length;let s=0,u=0,m=0,v=0;for(const b of a)s+=b.total,u+=b.sold,m+=b.remaining,v+=b.revenueIdr;return{totalEvents:t,totalTickets:s,totalSold:u,totalRemaining:m,totalRevenueIdr:v}});async function ve(){try{const a=await U("/api/me");f.value=a?.role||"customer"}catch(a){console.error(a),w.value=a.message||"Gagal mengambil role user"}}async function J(){y.value=!0,w.value="";try{const a=await U("/api/events?all=1&include_unlisted=1");z.value=Array.isArray(a?.items)?a.items:[]}catch(a){console.error(a),w.value=a.message||"Gagal memuat data event"}finally{y.value=!1}}return ge(async()=>{await ve(),f.value==="admin"&&(await J(),await ie(),await re())}),(a,t)=>(o(),n("div",Ee,[e("header",Oe,[t[5]||(t[5]=e("div",{class:"brand"},[e("img",{src:fe,alt:"Tickety"})],-1)),t[6]||(t[6]=e("div",{class:"topbar-title"},"Admin Dashboard",-1)),e("button",{class:"hamburger",onClick:ye(ee,["stop"]),"aria-label":"Toggle Sidebar"},[...t[4]||(t[4]=[e("span",null,null,-1),e("span",null,null,-1),e("span",null,null,-1)])])]),_e(we,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=s=>C.value=s)},null,8,["modelValue"]),e("main",xe,[t[24]||(t[24]=e("section",{class:"hero hero--compact"},[e("div",{class:"hero-text"},[e("p",{class:"badge"},"Admin"),e("h1",null,"Ringkasan Penjualan Tiket"),e("p",{class:"muted"},"Pantau performa semua event yang terdaftar di platform.")])],-1)),f.value==="admin"?(o(),n("section",Ie,[e("article",We,[t[7]||(t[7]=e("p",{class:"label"},"Total Event",-1)),e("p",Be,l(M.value.totalEvents),1)]),e("article",De,[t[8]||(t[8]=e("p",{class:"label"},"Total Tiket",-1)),e("p",Le,l(M.value.totalTickets),1)]),e("article",Ne,[t[9]||(t[9]=e("p",{class:"label"},"Tiket Terjual",-1)),e("p",qe,l(M.value.totalSold),1)]),e("article",Ve,[t[10]||(t[10]=e("p",{class:"label"},"Tiket Tersisa",-1)),e("p",je,l(M.value.totalRemaining),1)]),e("article",Fe,[t[11]||(t[11]=e("p",{class:"label"},"Perkiraan Pendapatan",-1)),e("p",Ge," Rp "+l(L(M.value.totalRevenueIdr)||"0"),1)])])):i("",!0),f.value==="admin"?(o(),n("section",He,[e("header",Ue,[t[12]||(t[12]=e("h2",null,"Detail Event",-1)),e("button",{class:"refresh",onClick:J,disabled:y.value},l(y.value?"Memuat…":"Refresh"),9,ze)]),w.value?(o(),n("p",Je,l(w.value),1)):i("",!0),!y.value&&!w.value&&N.value.length===0?(o(),n("div",Ke," Belum ada event yang tercatat. ")):(o(),n("div",Xe,[e("table",Qe,[t[13]||(t[13]=e("thead",null,[e("tr",null,[e("th",null,"Event"),e("th",null,"Tanggal"),e("th",null,"Terjual / Total"),e("th",null,"Sisa"),e("th",null,"Harga (Rp)"),e("th",null,"Pendapatan (Rp)"),e("th",null,"Status"),e("th",null,"Promoter"),e("th",null,"Aksi")])],-1)),e("tbody",null,[(o(!0),n(be,null,Ae(N.value,s=>(o(),n("tr",{key:s.id},[e("td",null,[e("div",Ye,[e("div",Ze,l(s.title),1),e("div",et,l(s.venue),1)])]),e("td",null,l(s.dateLabel),1),e("td",null,l(s.sold)+" / "+l(s.total),1),e("td",null,l(s.remaining),1),e("td",null,"Rp "+l(L(s.priceIdr)||"0"),1),e("td",null,"Rp "+l(L(s.revenueIdr)||"0"),1),e("td",null,[e("span",{class:q(["pill",s.listed?"pill--green":"pill--gray"])},l(s.listed?"Listed":"Unlisted"),3)]),e("td",null,[e("span",tt,l(s.promoterWallet||"-"),1)]),e("td",null,[e("button",{class:"btn-detail",type:"button",onClick:u=>ue(s.id)}," Detail ",8,at)])]))),128))])])]))])):i("",!0),f.value==="admin"?(o(),n("section",st,[t[22]||(t[22]=e("header",{class:"table-header"},[e("h2",null,"Manajemen Promoter (On-chain)")],-1)),x.value?(o(),n("p",lt,l(x.value),1)):i("",!0),T(S)?(o(),n("div",nt,[e("div",ot,[t[14]||(t[14]=e("span",{class:"k"},"Contract",-1)),e("a",{class:"mono link",href:`${$}/address/${T(S)}`,target:"_blank",rel:"noreferrer"},l(T(S)),9,rt)]),k.value?(o(),n("div",it,[t[15]||(t[15]=e("span",{class:"k"},"Owner",-1)),e("a",{class:"mono link",href:`${$}/address/${k.value}`,target:"_blank",rel:"noreferrer"},l(k.value),9,ut),e("span",{class:q(["pill",D.value?"pill--green":"pill--gray"])},l(D.value?"Wallet Admin = Owner":"Wallet Admin ≠ Owner"),3)])):i("",!0),e("div",ct,[t[16]||(t[16]=e("span",{class:"k"},"Wallet",-1)),T(c)?(o(),n("a",{key:0,class:"mono link",href:se.value,target:"_blank",rel:"noreferrer"},l(T(c)),9,dt)):(o(),n("span",mt,"Belum connect")),e("button",{class:"btn ghost",onClick:F,disabled:I.value},l(I.value?"Connecting…":"Connect Wallet"),9,vt)]),_.value?(o(),n("p",pt,l(_.value),1)):i("",!0),!D.value&&T(c)?(o(),n("p",ht,[...t[17]||(t[17]=[B(" Catatan: fungsi ",-1),e("span",{class:"mono"},"setPromoter",-1),B(" biasanya hanya bisa dipanggil oleh ",-1),e("span",{class:"mono"},"owner",-1),B(". Jika wallet admin Anda bukan owner, transaksi kemungkinan ",-1),e("span",{class:"mono"},"revert",-1),B(". ",-1)])])):i("",!0)])):i("",!0),e("div",kt,[t[21]||(t[21]=e("label",{class:"lbl"},"Wallet Address",-1)),Te(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>E.value=s),class:"inp mono",placeholder:"0x...",autocomplete:"off",spellcheck:"false"},null,512),[[Ce,E.value]]),e("div",gt,[e("button",{class:"btn primary",onClick:G,disabled:O.value},l(O.value?"Checking…":"Check"),9,_t),e("button",{class:"btn primary",onClick:t[2]||(t[2]=s=>H(!0)),disabled:P.value},l(P.value?"Processing…":"Add Promoter"),9,ft),e("button",{class:"btn ghost",onClick:t[3]||(t[3]=s=>H(!1)),disabled:P.value}," Remove Promoter ",8,yt)]),d.value?(o(),n("p",wt,l(d.value),1)):i("",!0),p.value?(o(),n("p",bt,l(p.value),1)):i("",!0),g.value?(o(),n("div",At,[e("div",Tt,[t[18]||(t[18]=e("span",{class:"k"},"Address",-1)),e("a",{class:"mono link",href:le.value,target:"_blank",rel:"noreferrer"},l(g.value),9,Ct)]),R.value!==null?(o(),n("div",St,[t[19]||(t[19]=e("span",{class:"k"},"Status",-1)),e("span",{class:q(["pill",R.value?"pill--green":"pill--gray"])},l(R.value?"PROMOTER":"NOT PROMOTER"),3)])):i("",!0),h.value?(o(),n("div",Rt,[t[20]||(t[20]=e("span",{class:"k"},"Tx",-1)),e("a",{class:"mono link",href:ne.value,target:"_blank",rel:"noreferrer"},l(h.value),9,Pt)])):i("",!0)])):i("",!0)])])):i("",!0),f.value!=="admin"&&!y.value?(o(),n("section",Mt,[...t[23]||(t[23]=[e("p",{class:"error"},"Halaman ini hanya untuk admin.",-1)])])):i("",!0)])]))}},Wt=pe($t,[["__scopeId","data-v-b3c6aa31"]]);export{Wt as default};
