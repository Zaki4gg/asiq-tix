import{r as S,b,i as v,w as j,o as z,s as J,d as c,e as Y,v as Q,S as Z,t as D,x as tt,F as et,l as at,y as nt,h as ot,j as q}from"./index-B7XfvEUy.js";const st=["disabled"],lt={key:0},it={key:1},rt={__name:"Tiket_Download",props:{eventId:{type:[String,Number],default:null},ticketCode:{type:String,default:""},fallbackTitle:{type:String,default:"Tiket AsiqTIX"},fallbackDate:{type:[String,Number,Date],default:""},fallbackLocation:{type:String,default:""},fallbackBannerUrl:{type:String,default:""}},setup(F){const k=F,h=S(!1),I=`${"http://localhost:3001".replace(/\/+$/,"")}/api`;function A(n){if(!n)return"-";try{const l=typeof n=="string"||typeof n=="number"?new Date(n):n;if(!Number.isFinite(l.getTime()))return"-";const s=l.toLocaleDateString("id-ID",{weekday:"long"}).toUpperCase(),u=l.toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"2-digit"}),f=l.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(/\./g,":");return`${s}, ${u} - ${f}`}catch{return"-"}}function y(n,l,s,u,f,C){let i=C;typeof i=="number"?i={tl:i,tr:i,br:i,bl:i}:i={tl:i.tl||0,tr:i.tr||0,br:i.br||0,bl:i.bl||0},n.beginPath(),n.moveTo(l+i.tl,s),n.lineTo(l+u-i.tr,s),n.quadraticCurveTo(l+u,s,l+u,s+i.tr),n.lineTo(l+u,s+f-i.br),n.quadraticCurveTo(l+u,s+f,l+u-i.br,s+f),n.lineTo(l+i.bl,s+f),n.quadraticCurveTo(l,s+f,l,s+f-i.bl),n.lineTo(l,s+i.tl),n.quadraticCurveTo(l,s,l+i.tl,s),n.closePath()}async function w(){if(!h.value){h.value=!0;try{let n=null;if(k.eventId)try{const p=await fetch(`${I}/events/${k.eventId}`),o=await p.json().catch(()=>null);p.ok&&(n=o)}catch(p){console.warn("[TicketDownloadButton] gagal load event meta",p)}const l=n?.title||k.fallbackTitle||"Tiket AsiqTIX",s=n?.venue||n?.location||k.fallbackLocation||"-",u=n?.date_iso||null,f=n?.image_url||n?.poster_url||n?.banner_url||k.fallbackBannerUrl||"",C=A(u||k.fallbackDate),i=k.ticketCode||n?.id||k.eventId||"-";await M({title:l,location:s,timeText:C,ticketId:i,bannerUrl:f})}catch(n){console.error("[TicketDownloadButton] gagal generate tiket",n),alert("Gagal membuat file tiket. Silakan coba lagi.")}finally{h.value=!1}}}async function M({title:n,location:l,timeText:s,ticketId:u,bannerUrl:f}){const p=document.createElement("canvas");p.width=1200,p.height=560;const o=p.getContext("2d");if(!o)throw new Error("Canvas 2D context tidak tersedia");const O="#f7f0d6",U="#1f2347",x="#fdfdfd";o.fillStyle=O,o.fillRect(0,0,1200,560);const R=30,P=30,L=1140,N=500;y(o,R,P,L,N,50),o.fillStyle=U,o.fill();const a=40,t=N-a*2,e=R+a,r=P+a,d=e+t+40,g=r+10,m=42;if(f){const $=new Image;$.crossOrigin="anonymous",$.src=f,await new Promise(X=>{$.onload=()=>X(!0),$.onerror=()=>X(!1)}),o.save(),y(o,e,r,t,t,30),o.clip(),o.drawImage($,e,r,t,t),o.restore()}else o.save(),y(o,e,r,t,t,30),o.clip(),o.fillStyle="#333a60",o.fillRect(e,r,t,t),o.fillStyle="#cbd2ff",o.font='24px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI"',o.fillText("NO POSTER",e+40,r+t/2),o.restore();o.fillStyle=x;const V=`"${n}"`;o.font='28px "Segoe UI", system-ui, -apple-system, sans-serif',o.fillText(V,d,g+m*.7),o.font='22px "Segoe UI", system-ui, -apple-system, sans-serif';const T=g+m*2,_=T+m*1.1,W=_+m*1.1;o.fillText("ID",d,T),o.fillText(String(u),d+140,T),o.fillText("TEMPAT",d,_),o.fillText(l,d+140,_),o.fillText("WAKTU",d,W),o.fillText(s||"-",d+140,W);const G=String(n).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),B=document.createElement("a");B.download=`ticket-${G||"asiqtix"}-${u}.png`,B.href=p.toDataURL("image/png"),document.body.appendChild(B),B.click(),document.body.removeChild(B)}return(n,l)=>(v(),b("button",{type:"button",class:"btn ticket-download-btn",disabled:h.value,onClick:w},[h.value?(v(),b("span",lt,"Mengunduh…")):(v(),b("span",it,"DOWNLOAD TICKET"))],8,st))}},ct={},ut={class:"history-page"},dt={class:"wrap"},ft={key:0,class:"alert"},mt={key:1,class:"alert error"},gt={key:2,class:"list",role:"list"},ht={class:"header-line"},pt={class:"event"},kt={class:"meta"},yt={key:0,class:"item"},E="0x13882",bt="0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",wt={__name:"History",setup(F){const k=ot(),h=S(!1),K=()=>h.value=!h.value;j(()=>k.fullPath,()=>h.value=!1);const I=S([]),A=S(!0),y=S(""),w=typeof window<"u"&&!!window.ethereum,M="http://localhost:3001".replace(/\/+$/,""),n="0xd0c718240519a2a843F2c9d2A8321ADD9caa1F15".trim().toLowerCase(),l=Number(ct?.VITE_TICKET_START_BLOCK||0)||0,s=S(""),u=S("");async function f(){if(w)try{const[a]=await window.ethereum.request({method:"eth_accounts"});s.value=a||"",u.value=await window.ethereum.request({method:"eth_chainId"}).catch(()=>""),s.value&&await C()}catch{}}async function C(){if(!w)return!1;if(u.value?.toLowerCase()===E)return!0;try{return await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:E}]}),u.value=E,!0}catch(a){if(a?.code===4902)try{return await window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:E,chainName:"Polygon Amoy",rpcUrls:["https://rpc-amoy.polygon.technology"],nativeCurrency:{name:"POL",symbol:"POL",decimals:18},blockExplorerUrls:["https://amoy.polygonscan.com"]}]}),u.value=E,!0}catch{}return!1}}function i(a){const t=String(a||"").toLowerCase().replace(/^0x/,"");return"0x"+"0".repeat(24)+t}function p(a){try{return BigInt(a).toString(10)}catch{return"0"}}function o(a){return"0x"+Math.max(0,Number(a||0)).toString(16)}function O(a){try{return new Date(a).toLocaleDateString("id-ID")}catch{return""}}function U(a){return"Rp "+Math.abs(Number(a)||0).toLocaleString("id-ID")}async function x(a,t){const e=a.startsWith("http")?a:`${M}${a}`,r={};s.value&&(r["x-wallet-address"]=s.value.toLowerCase());const d=await fetch(e,{...t,headers:r,credentials:"include"}),g=await d.text().catch(()=>"");let m;try{m=g?JSON.parse(g):null}catch{m={message:g}}if(!d.ok)throw new Error(m?.error||m?.message||"Request failed");return m}async function R(){const a=await x("/api/transactions");return(Array.isArray(a)?a:[]).filter(e=>(e?.kind||"").toLowerCase()==="purchase").map(e=>{const r=e.created_at,d=(e.ticket_id||e.ticket_no||e.ref_id||e.id||"").toString();return{_sortAt:+new Date(r),id:e.id,title:"Ticket purchase",date:O(r),booking:d.slice(0,16),price:U(e.amount),status:e.status||"Successful",eventId:e.ref_id||null,ticketId:d,dateIso:r,location:e.location||""}})}async function P(){if(!w||!s.value||!n)return[];if(!l)return console.warn("[history] START_BLOCK tidak diset, skip load tiket on-chain"),[];try{const a=o(l),t="latest",e=i(s.value),r=await window.ethereum.request({method:"eth_getLogs",params:[{address:n,fromBlock:a,toBlock:t,topics:[bt,null,e]}]}),d=[];for(const g of r){const m=await window.ethereum.request({method:"eth_getBlockByNumber",params:[g.blockNumber,!1]}).catch(()=>null),V=p(g.topics?.[3]||"0x0"),T=m?.timestamp?Number(BigInt(m.timestamp)*1000n):Date.now(),_=String(V);d.push({_sortAt:T,id:`${g.transactionHash}-${_}`,title:`NFT Ticket #${_}`,date:O(T),booking:(g.transactionHash||"").slice(0,16),price:"—",status:"Successful",eventId:null,ticketId:_,dateIso:new Date(T).toISOString(),location:""})}return d.sort((g,m)=>m._sortAt-g._sortAt),d}catch(a){return console.warn("[history] gagal load tiket on-chain, di-skip",a),[]}}async function L(){A.value=!0,y.value="",I.value=[];try{if(!w){y.value="MetaMask tidak terdeteksi di browser.";return}if(!s.value){y.value="Silakan koneksikan MetaMask terlebih dahulu.";return}const a=await R().catch(r=>{throw console.error("[history] ledger error",r),r});let t=[];try{t=await P()}catch(r){console.warn("[history] on-chain history gagal, di-skip",r)}const e=[...a,...t].sort((r,d)=>d._sortAt-r._sortAt);I.value=e}catch(a){console.error("[history] gagal load",a),y.value=String(a?.message||a)||"Gagal memuat riwayat pembelian tiket."}finally{A.value=!1}}function N(a){s.value=a?.[0]||"",L()}function H(a){u.value=a||"",L()}return z(async()=>{await f(),await L(),w&&(window.ethereum.on?.("accountsChanged",N),window.ethereum.on?.("chainChanged",H))}),J(()=>{w&&(window.ethereum.removeListener?.("accountsChanged",N),window.ethereum.removeListener?.("chainChanged",H))}),(a,t)=>(v(),b("div",ut,[c("header",{class:"topbar"},[t[2]||(t[2]=c("div",{class:"brand"},[c("img",{src:Q,alt:"AsiqTIX"})],-1)),t[3]||(t[3]=c("h1",{class:"title"},"History",-1)),c("button",{class:"hamburger","aria-label":"Toggle menu",onClick:K},[...t[1]||(t[1]=[c("span",null,null,-1),c("span",null,null,-1),c("span",null,null,-1)])])]),Y(Z,{modelValue:h.value,"onUpdate:modelValue":t[0]||(t[0]=e=>h.value=e),extraClass:"sb-topright"},null,8,["modelValue"]),c("main",dt,[t[9]||(t[9]=c("h2",{class:"section-title"},"Riwayat Tiket",-1)),A.value?(v(),b("div",ft,"Loading…")):y.value?(v(),b("div",mt,D(y.value),1)):(v(),b("ul",gt,[(v(!0),b(et,null,at(I.value,e=>(v(),b("li",{key:e.id,class:"item"},[c("div",ht,[c("h3",pt,D(e.title),1),Y(rt,{"event-id":e.eventId,"ticket-code":e.ticketId||e.booking,"fallback-title":e.title,"fallback-date":e.dateIso||e.date,"fallback-location":e.location},null,8,["event-id","ticket-code","fallback-title","fallback-date","fallback-location"])]),c("div",kt,[c("p",null,[t[4]||(t[4]=c("strong",null,"Date:",-1)),q(" "+D(e.date),1)]),c("p",null,[t[5]||(t[5]=c("strong",null,"ID:",-1)),q(" "+D(e.booking),1)]),c("p",null,[t[6]||(t[6]=c("strong",null,"Price:",-1)),q(" "+D(e.price),1)]),c("p",null,[t[7]||(t[7]=c("strong",null,"Status:",-1)),q(" "+D(e.status),1)])])]))),128)),I.value.length?tt("",!0):(v(),b("li",yt,[...t[8]||(t[8]=[nt('<div class="header-line"><h3 class="event">—</h3><button class="btn" disabled>DOWNLOAD TICKET</button></div><div class="meta"><p><strong>Date:</strong> —</p><p><strong>ID:</strong> —</p><p><strong>Price:</strong> —</p><p><strong>Status:</strong> —</p></div>',2)])]))]))])]))}};export{wt as default};
