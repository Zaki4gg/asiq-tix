import{r as c,w as A,c as E,u as J,o as K,q as Q,a as w,b as t,d as B,S as X,t as u,F as Z,h as ee,s as te,x as ne,y as ae,m as se,z as oe,p as f,i as le,j as ie}from"./index-DrDbhAjG.js";const re=`<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="980.000000pt" height="980.000000pt" viewBox="0 0 980.000000 980.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,980.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M4615 8269 c-609 -52 -1208 -276 -1705 -637 -636 -464 -1104 -1158
-1290 -1916 -191 -777 -102 -1601 250 -2306 405 -813 1101 -1424 1950 -1712
562 -190 1172 -228 1760 -108 1651 337 2814 1872 2691 3550 -60 817 -404 1571
-977 2144 -535 535 -1200 864 -1954 967 -170 23 -554 33 -725 18z m575 -509
c562 -59 1089 -278 1535 -639 101 -82 331 -313 409 -411 346 -434 561 -951
622 -1490 16 -145 18 -462 4 -600 -40 -386 -167 -783 -356 -1114 -56 -97 -191
-303 -205 -312 -5 -3 -38 19 -72 48 -483 422 -1111 696 -1772 773 -166 20
-530 23 -685 6 -731 -80 -1368 -367 -1907 -858 l-79 -71 -49 61 c-27 34 -83
111 -123 171 -233 349 -375 704 -449 1124 -26 149 -28 173 -27 457 0 328 10
423 74 684 179 727 641 1360 1284 1758 353 218 759 359 1176 408 130 15 492
18 620 5z"/>
<path d="M4780 6609 c-322 -57 -603 -266 -747 -554 -37 -73 -78 -199 -92 -279
-16 -85 -13 -282 3 -368 77 -391 360 -691 754 -800 64 -18 106 -22 247 -22
148 -1 181 2 255 22 521 142 846 643 755 1163 -68 393 -355 709 -737 815 -75
21 -121 26 -238 29 -80 2 -170 0 -200 -6z"/>
</g>
</svg>
`,ce={class:"profile-page"},de={class:"content"},ue={class:"grid"},ve={class:"profile-card"},he={class:"avatar"},we=["innerHTML"],fe={class:"profile-meta"},pe={class:"addr"},me={class:"wallet-mini"},_e={class:"acc"},ge=["disabled"],ye={class:"history-card"},Ce={key:0,class:"alert error",style:{margin:"10px 0"}},ke={key:1,class:"alert",style:{margin:"10px 0"}},Ie={key:2},Se={class:"table"},be={"data-col":"Concert(s)"},Le={"data-col":"Payment Date"},xe={"data-col":"Price"},De={"data-col":"Status"},Te={"data-col":"Action"},Pe=["disabled","onClick"],Ae={class:"see-all"},Me={__name:"Profile",setup(Ee){const M=se(),O=oe(),p=c(!1),H=()=>p.value=!p.value;A(()=>M.fullPath,()=>p.value=!1);const{account:d}=J(),i=E(()=>d.value||"");async function $(){if(!d.value&&window?.ethereum)try{const e=await window.ethereum.request({method:"eth_accounts"});e?.[0]&&(d.value=e[0])}catch{}}function x(e){d.value=e?.[0]||"",d.value?(S(),h(),I()):(b(),m.value=0n,v.value=[])}const R=c("0x0"),V=c("ETH"),m=c(0n),N=e=>e===137||e===80002?"POL":"ETH";async function y(){if(window?.ethereum)try{const e=await window.ethereum.request({method:"eth_chainId"});R.value=e,V.value=N(Number(e))}catch{}}async function h(){if(!window?.ethereum||!d.value){m.value=0n;return}try{const e=await window.ethereum.request({method:"eth_getBalance",params:[d.value,"latest"]});m.value=BigInt(e)}catch{m.value=0n}}function D(){y(),h()}const T="http://localhost:3001".replace(/\/+$/,"");async function C(e,n){const l=e.startsWith("http")?e:`${T}${e}`,s={"x-wallet-address":i.value.toLowerCase()},o=await fetch(l,{...n,headers:s}),r=await o.text().catch(()=>"");let a=null;try{a=r?JSON.parse(r):null}catch{a={message:r}}if(!o.ok)throw new Error(a?.error||a?.message||"Request failed");return a}const v=c([]),k=c(!1),_=c(""),U=e=>{try{return new Date(e).toISOString().slice(0,10)}catch{return""}},q=e=>"Rp "+Math.abs(Number(e)||0).toLocaleString("id-ID");function P(e){return{id:e.id,eventId:e.ref_id||null,event:e.event_title||null,date:U(e.created_at||Date.now()),price:q(e.amount),status:(e.status||"confirmed").replace(/^./,n=>n.toUpperCase())}}async function I(){if(_.value="",!i.value){v.value=[];return}try{k.value=!0;const e=await C("/transactions");let l=(Array.isArray(e)?e:[]).filter(o=>(o.kind||"").toLowerCase()==="purchase").map(P);const s=[...new Set(l.filter(o=>o.eventId&&!o.event).map(o=>o.eventId))];if(s.length){const o=await Promise.allSettled(s.map(a=>C(`/api/events/${a}`))),r={};o.forEach((a,j)=>{a.status==="fulfilled"&&a.value&&(r[s[j]]=a.value?.title||"(Unlisted)")}),l.forEach(a=>{!a.event&&a.eventId&&r[a.eventId]&&(a.event=r[a.eventId])})}l.sort((o,r)=>new Date(r.date)-new Date(o.date)),v.value=l.slice(0,3)}catch(e){_.value=String(e?.message||e),v.value=[]}finally{k.value=!1}}let g=null;function S(){b(),i.value&&(g=ae(T,{transports:["websocket"],auth:{address:i.value.toLowerCase()}}),g.on("tx:new",e=>{if((e?.wallet||"").toLowerCase()===i.value.toLowerCase()&&(h(),(e.kind||"").toLowerCase()==="purchase")){const n=P(e);!n.event&&n.eventId&&C(`/events/${n.eventId}`).then(l=>{n.event=l?.title||n.event||"(Unlisted)"}).catch(()=>{}),v.value.findIndex(l=>l.id===n.id)===-1&&v.value.unshift(n)}}))}function b(){g?.disconnect?.(),g=null}const W=c(""),z=c(""),Y=e=>e?`${e.slice(0,6)}…${e.slice(-4)}`:"";function F(){i.value&&(navigator.clipboard.writeText(i.value),alert("Wallet address copied."))}const G=E(()=>re);let L=null;return K(async()=>{await $(),await y(),await h(),await I(),i.value&&S(),window?.ethereum?.on&&(window.ethereum.on("accountsChanged",x),window.ethereum.on("chainChanged",D)),L=window.setInterval(h,15e3)}),Q(()=>{window?.ethereum?.removeListener&&(window.ethereum.removeListener("accountsChanged",x),window.ethereum.removeListener("chainChanged",D)),L&&clearInterval(L),b()}),A(d,async()=>{await y(),await h(),await I(),i.value&&S()}),(e,n)=>{const l=ne("router-link");return f(),w("div",ce,[t("header",{class:"header"},[n[2]||(n[2]=t("h1",{class:"sr-only"},"Profile",-1)),t("button",{class:"hamburger",type:"button","aria-label":"Toggle sidebar",onClick:H},[...n[1]||(n[1]=[t("span",null,null,-1),t("span",null,null,-1),t("span",null,null,-1)])])]),B(X,{modelValue:p.value,"onUpdate:modelValue":n[0]||(n[0]=s=>p.value=s)},null,8,["modelValue"]),t("div",de,[t("div",ue,[t("aside",ve,[t("div",he,[t("div",{class:"avatar-svg",innerHTML:G.value},null,8,we)]),t("div",fe,[t("h3",null,u(W.value),1),t("p",pe,u(z.value),1)]),t("div",me,[n[3]||(n[3]=t("h3",null,"Wallet",-1)),t("p",_e,u(Y(i.value)||"-"),1),t("button",{class:"copy",disabled:!i.value,onClick:F},"COPY",8,ge)])]),t("section",ye,[n[6]||(n[6]=t("h2",null,"Purchase History",-1)),_.value?(f(),w("div",Ce,u(_.value),1)):k.value?(f(),w("div",ke,"Loading…")):(f(),w("div",Ie,[n[5]||(n[5]=t("div",{class:"thead"},[t("div",null,"Concert(s)"),t("div",null,"Payment Date"),t("div",null,"Price"),t("div",null,"Status"),t("div",null,"Action")],-1)),t("div",Se,[(f(!0),w(Z,null,ee(v.value,s=>(f(),w("div",{class:"trow",key:s.id},[t("div",be,u(s.event||"(Unknown Event)"),1),t("div",Le,u(s.date),1),t("div",xe,u(s.price),1),t("div",De,u(s.status),1),t("div",Te,[t("button",{class:"detail-btn",disabled:!s.eventId,onClick:o=>s.eventId&&le(O).push(`/events/${s.eventId}`)},"DETAIL",8,Pe)])]))),128))]),t("div",Ae,[B(l,{to:"/history"},{default:te(()=>[...n[4]||(n[4]=[ie(" Lihat semua riwayat tiket → ",-1)])]),_:1})])]))])])])])}}};export{Me as default};
