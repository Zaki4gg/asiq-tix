import{_ as me,r,w as ve,c as b,u as pe,o as he,a as n,b as e,d as ke,e as ge,f as _e,S as fe,g as i,t as l,F as we,h as ye,i as A,n as V,j as B,k as be,v as Ae,B as Te,C as X,A as Q,l as Ce,J as Se,m as Re,p as o}from"./index-DrDbhAjG.js";const Pe={class:"home-page",style:{"--hero-img":"url(/Background.png)"}},Me={class:"topbar"},$e={class:"container dashboard"},Ee={key:0,class:"summary-grid"},Ie={class:"summary-card"},Oe={class:"value"},xe={class:"summary-card"},We={class:"value"},Be={class:"summary-card"},Le={class:"value"},Ne={class:"summary-card"},De={class:"value"},Ve={class:"summary-card"},je={class:"value"},qe={key:1,class:"table-section"},Fe={class:"table-header"},Ge=["disabled"],He={key:0,class:"error"},Ue={key:1,class:"empty"},ze={key:2,class:"table-wrapper"},Je={class:"table"},Ke={class:"cell-title"},Xe={class:"title"},Qe={class:"sub"},Ye={class:"mono"},Ze={key:2,class:"promoter-section"},et={key:0,class:"error"},tt={key:1,class:"promoter-meta"},at={class:"row"},st=["href"],lt={key:0,class:"row"},nt=["href"],ot={class:"row"},rt=["href"],it={key:1,class:"mono"},ut=["disabled"],dt={key:1,class:"error"},ct={key:2,class:"hint"},mt={class:"promoter-form"},vt={class:"promoter-actions"},pt=["disabled"],ht=["disabled"],kt=["disabled"],gt={key:0,class:"error"},_t={key:1,class:"ok"},ft={key:2,class:"promoter-result"},wt={class:"row"},yt=["href"],bt={key:0,class:"row"},At={key:1,class:"row"},Tt=["href"],Ct={key:3,class:"forbidden"},$="https://amoy.polygonscan.com",St={__name:"Admin_Dashboard",setup(Rt){const Y=Re(),T=r(!1),Z=()=>T.value=!T.value;ve(()=>Y.fullPath,()=>T.value=!1);const{account:d,ensureChain:ee}=pe(),C="0xd0c718240519a2a843F2c9d2A8321ADD9caa1F15",te="https://rpc-amoy.polygon.technology",E=r(""),g=r(""),S=r(null),I=r(!1),c=r(""),R=r(!1),p=r(""),h=r(""),k=r(""),O=r(""),_=r(""),x=r(!1),ae=b(()=>d.value?`${$}/address/${d.value}`:""),se=b(()=>g.value?`${$}/address/${g.value}`:""),le=b(()=>h.value?`${$}/tx/${h.value}`:""),L=b(()=>!k.value||!d.value?!1:String(k.value).toLowerCase()===String(d.value).toLowerCase());function j(a){const t=String(a||"").trim();if(!t)return"";try{return Ce(t)}catch{return""}}let W=null;function ne(){return W||(W=new Se(te),W)}function q(){return new X(C,Q,ne())}async function oe(){_.value="";try{if(!window?.ethereum?.request)return;const a=await window.ethereum.request({method:"eth_accounts"});Array.isArray(a)&&a[0]&&(d.value=a[0])}catch(a){console.warn("syncWalletSilent error:",a)}}async function F(){_.value="",x.value=!0;try{if(!window?.ethereum?.request){_.value="MetaMask tidak terdeteksi. Install/aktifkan MetaMask extension.";return}const a=await window.ethereum.request({method:"eth_requestAccounts"});Array.isArray(a)&&a[0]&&(d.value=a[0])}catch(a){console.error(a),_.value=a?.message||"Gagal connect wallet."}finally{x.value=!1}}async function re(){O.value="",k.value="";try{const t=await q().owner();k.value=String(t||"")}catch(a){console.error(a),O.value=a?.message||"Gagal mengambil owner kontrak."}}async function G(){c.value="",p.value="",h.value="",S.value=null;const a=j(E.value);if(g.value=a,!a){c.value="Alamat wallet tidak valid.";return}I.value=!0;try{const s=await q().isPromoter(a);S.value=!!s}catch(t){console.error(t),c.value=t?.reason||t?.message||"Gagal memeriksa status promoter."}finally{I.value=!1}}async function H(a){c.value="",p.value="",h.value="";const t=j(E.value);if(g.value=t,!t){c.value="Alamat wallet tidak valid.";return}if(!window?.ethereum?.request){c.value="MetaMask tidak terdeteksi. Untuk menambah/menghapus promoter, Anda harus memakai MetaMask extension.";return}const s=!!a,u=s?"menambahkan":"menghapus";if(window.confirm(`Konfirmasi: ${u} promoter untuk wallet
${t}

Transaksi akan muncul di MetaMask.`)){R.value=!0;try{d.value||await F(),await ee("amoy");const y=await new Te(window.ethereum).getSigner(),K=await new X(C,Q,y).setPromoter(t,s);h.value=K?.hash||"",p.value="Transaksi dikirim. Menunggu konfirmasi…",await K.wait(),p.value="Berhasil. Status promoter sudah diperbarui di blockchain.",await G()}catch(v){console.error(v),p.value="",c.value=v?.reason||v?.shortMessage||v?.message||"Transaksi gagal."}finally{R.value=!1}}}const ie="http://localhost:3001".replace(/\/+$/,"").replace(/\/api$/i,""),ue=()=>(localStorage.getItem("walletAddress")||"").toString();async function U(a,t={}){const s=a.startsWith("/api")?a:`/api${a.startsWith("/")?a:`/${a}`}`,u=await fetch(`${ie}${s}`,{...t,headers:{"content-type":"application/json",...t.headers||{},"x-wallet-address":ue()}}),m=await u.json().catch(()=>({}));if(!u.ok)throw new Error(m?.error||m?.message||`HTTP ${u.status}`);return m}function N(a){return a?String(Math.round(a)).replace(/\B(?=(\d{3})+(?!\d))/g,"."):""}function de(a){if(!a)return"-";const t=new Date(a);return Number.isFinite(t.getTime())?t.toLocaleString("id-ID",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):a}const f=r("customer"),w=r(!1),P=r(""),z=r([]),D=b(()=>z.value.map(a=>{const t=Number(a.sold_tickets||0),s=Number(a.total_tickets||0),u=Number(a.price_idr||0),m=t*u;return{id:a.id,title:a.title,venue:a.venue,dateLabel:de(a.date_iso),sold:t,total:s,remaining:Math.max(s-t,0),priceIdr:u,revenueIdr:m,listed:!!a.listed,promoterWallet:a.promoter_wallet||null}})),M=b(()=>{const a=D.value,t=a.length;let s=0,u=0,m=0,v=0;for(const y of a)s+=y.total,u+=y.sold,m+=y.remaining,v+=y.revenueIdr;return{totalEvents:t,totalTickets:s,totalSold:u,totalRemaining:m,totalRevenueIdr:v}});async function ce(){try{const a=await U("/api/me");f.value=a?.role||"customer"}catch(a){console.error(a),P.value=a.message||"Gagal mengambil role user"}}async function J(){w.value=!0,P.value="";try{const a=await U("/api/events?all=1&include_unlisted=1");z.value=Array.isArray(a?.items)?a.items:[]}catch(a){console.error(a),P.value=a.message||"Gagal memuat data event"}finally{w.value=!1}}return he(async()=>{await ce(),f.value==="admin"&&(await J(),await re(),await oe())}),(a,t)=>(o(),n("div",Pe,[e("header",Me,[t[5]||(t[5]=e("div",{class:"brand"},[e("img",{src:ge,alt:"Tickety"})],-1)),t[6]||(t[6]=e("div",{class:"topbar-title"},"Admin Dashboard",-1)),e("button",{class:"hamburger",onClick:_e(Z,["stop"]),"aria-label":"Toggle Sidebar"},[...t[4]||(t[4]=[e("span",null,null,-1),e("span",null,null,-1),e("span",null,null,-1)])])]),ke(fe,{modelValue:T.value,"onUpdate:modelValue":t[0]||(t[0]=s=>T.value=s)},null,8,["modelValue"]),e("main",$e,[t[24]||(t[24]=e("section",{class:"hero hero--compact"},[e("div",{class:"hero-text"},[e("p",{class:"badge"},"Admin"),e("h1",null,"Ringkasan Penjualan Tiket"),e("p",{class:"muted"},"Pantau performa semua event yang terdaftar di platform.")])],-1)),f.value==="admin"?(o(),n("section",Ee,[e("article",Ie,[t[7]||(t[7]=e("p",{class:"label"},"Total Event",-1)),e("p",Oe,l(M.value.totalEvents),1)]),e("article",xe,[t[8]||(t[8]=e("p",{class:"label"},"Total Tiket",-1)),e("p",We,l(M.value.totalTickets),1)]),e("article",Be,[t[9]||(t[9]=e("p",{class:"label"},"Tiket Terjual",-1)),e("p",Le,l(M.value.totalSold),1)]),e("article",Ne,[t[10]||(t[10]=e("p",{class:"label"},"Tiket Tersisa",-1)),e("p",De,l(M.value.totalRemaining),1)]),e("article",Ve,[t[11]||(t[11]=e("p",{class:"label"},"Perkiraan Pendapatan",-1)),e("p",je," Rp "+l(N(M.value.totalRevenueIdr)||"0"),1)])])):i("",!0),f.value==="admin"?(o(),n("section",qe,[e("header",Fe,[t[12]||(t[12]=e("h2",null,"Detail Event",-1)),e("button",{class:"refresh",onClick:J,disabled:w.value},l(w.value?"Memuat…":"Refresh"),9,Ge)]),P.value?(o(),n("p",He,l(P.value),1)):i("",!0),!w.value&&D.value.length===0?(o(),n("div",Ue," Belum ada event yang tercatat. ")):(o(),n("div",ze,[e("table",Je,[t[13]||(t[13]=e("thead",null,[e("tr",null,[e("th",null,"Event"),e("th",null,"Tanggal"),e("th",null,"Terjual / Total"),e("th",null,"Sisa"),e("th",null,"Harga (Rp)"),e("th",null,"Pendapatan (Rp)"),e("th",null,"Status"),e("th",null,"Promoter")])],-1)),e("tbody",null,[(o(!0),n(we,null,ye(D.value,s=>(o(),n("tr",{key:s.id},[e("td",null,[e("div",Ke,[e("div",Xe,l(s.title),1),e("div",Qe,l(s.venue),1)])]),e("td",null,l(s.dateLabel),1),e("td",null,l(s.sold)+" / "+l(s.total),1),e("td",null,l(s.remaining),1),e("td",null,"Rp "+l(N(s.priceIdr)||"0"),1),e("td",null,"Rp "+l(N(s.revenueIdr)||"0"),1),e("td",null,[e("span",{class:V(["pill",s.listed?"pill--green":"pill--gray"])},l(s.listed?"Listed":"Unlisted"),3)]),e("td",null,[e("span",Ye,l(s.promoterWallet||"-"),1)])]))),128))])])]))])):i("",!0),f.value==="admin"?(o(),n("section",Ze,[t[22]||(t[22]=e("header",{class:"table-header"},[e("h2",null,"Manajemen Promoter (On-chain)")],-1)),O.value?(o(),n("p",et,l(O.value),1)):i("",!0),A(C)?(o(),n("div",tt,[e("div",at,[t[14]||(t[14]=e("span",{class:"k"},"Contract",-1)),e("a",{class:"mono link",href:`${$}/address/${A(C)}`,target:"_blank",rel:"noreferrer"},l(A(C)),9,st)]),k.value?(o(),n("div",lt,[t[15]||(t[15]=e("span",{class:"k"},"Owner",-1)),e("a",{class:"mono link",href:`${$}/address/${k.value}`,target:"_blank",rel:"noreferrer"},l(k.value),9,nt),e("span",{class:V(["pill",L.value?"pill--green":"pill--gray"])},l(L.value?"Wallet Admin = Owner":"Wallet Admin ≠ Owner"),3)])):i("",!0),e("div",ot,[t[16]||(t[16]=e("span",{class:"k"},"Wallet",-1)),A(d)?(o(),n("a",{key:0,class:"mono link",href:ae.value,target:"_blank",rel:"noreferrer"},l(A(d)),9,rt)):(o(),n("span",it,"Belum connect")),e("button",{class:"btn ghost",onClick:F,disabled:x.value},l(x.value?"Connecting…":"Connect Wallet"),9,ut)]),_.value?(o(),n("p",dt,l(_.value),1)):i("",!0),!L.value&&A(d)?(o(),n("p",ct,[...t[17]||(t[17]=[B(" Catatan: fungsi ",-1),e("span",{class:"mono"},"setPromoter",-1),B(" biasanya hanya bisa dipanggil oleh ",-1),e("span",{class:"mono"},"owner",-1),B(". Jika wallet admin Anda bukan owner, transaksi kemungkinan ",-1),e("span",{class:"mono"},"revert",-1),B(". ",-1)])])):i("",!0)])):i("",!0),e("div",mt,[t[21]||(t[21]=e("label",{class:"lbl"},"Wallet Address",-1)),be(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>E.value=s),class:"inp mono",placeholder:"0x...",autocomplete:"off",spellcheck:"false"},null,512),[[Ae,E.value]]),e("div",vt,[e("button",{class:"btn primary",onClick:G,disabled:I.value},l(I.value?"Checking…":"Check"),9,pt),e("button",{class:"btn primary",onClick:t[2]||(t[2]=s=>H(!0)),disabled:R.value},l(R.value?"Processing…":"Add Promoter"),9,ht),e("button",{class:"btn ghost",onClick:t[3]||(t[3]=s=>H(!1)),disabled:R.value}," Remove Promoter ",8,kt)]),c.value?(o(),n("p",gt,l(c.value),1)):i("",!0),p.value?(o(),n("p",_t,l(p.value),1)):i("",!0),g.value?(o(),n("div",ft,[e("div",wt,[t[18]||(t[18]=e("span",{class:"k"},"Address",-1)),e("a",{class:"mono link",href:se.value,target:"_blank",rel:"noreferrer"},l(g.value),9,yt)]),S.value!==null?(o(),n("div",bt,[t[19]||(t[19]=e("span",{class:"k"},"Status",-1)),e("span",{class:V(["pill",S.value?"pill--green":"pill--gray"])},l(S.value?"PROMOTER":"NOT PROMOTER"),3)])):i("",!0),h.value?(o(),n("div",At,[t[20]||(t[20]=e("span",{class:"k"},"Tx",-1)),e("a",{class:"mono link",href:le.value,target:"_blank",rel:"noreferrer"},l(h.value),9,Tt)])):i("",!0)])):i("",!0)])])):i("",!0),f.value!=="admin"&&!w.value?(o(),n("section",Ct,[...t[23]||(t[23]=[e("p",{class:"error"},"Halaman ini hanya untuk admin.",-1)])])):i("",!0)])]))}},Et=me(St,[["__scopeId","data-v-39c98487"]]);export{Et as default};
