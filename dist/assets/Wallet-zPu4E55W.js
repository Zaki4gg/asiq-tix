import{_ as j,r as d,w as z,c as E,o as Y,D as G,a as h,b as n,d as K,e as Q,S as X,t as p,g as B,F as Z,h as ee,n as te,y as ae,m as ne,p as m}from"./index-yCoIpH8I.js";const oe={class:"container"},se={class:"panel"},le={class:"balance"},re={class:"balance-value"},ie={class:"addr muted",style:{"margin-top":"6px"}},ce=["title"],ue={class:"btns",style:{"margin-top":"10px"}},de=["disabled"],he={key:0,class:"alert error"},pe={key:1,class:"alert"},me={key:2,class:"tx-list",role:"list"},fe={class:"tx-main"},we={class:"tx-kind"},ve={class:"tx-amount"},ye={class:"tx-meta"},_e={class:"tx-date"},be=["href"],ge={key:0,class:"tx-item"},xe="POL",F="https://app.metamask.io/buy/build-quote",ke={__name:"Wallet",setup(Ce){const q=ne(),f=d(!1),R=()=>f.value=!f.value;z(()=>q.fullPath,()=>f.value=!1);const w=typeof window<"u"&&!!window.ethereum,o=d(""),y=d(""),b=d(0),i=d(null),c=E(()=>o.value||""),$=t=>t?`${t.slice(0,6)}…${t.slice(-4)}`:"";function L(t){const e=BigInt(t||"0x0"),a=10n**18n,s=e/a,r=(e%a).toString().padStart(18,"0").slice(0,6);return parseFloat(`${s}.${r}`)}async function W(){if(!w)return!1;if(y.value==="0x13882")return!0;try{return await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x13882"}]}),y.value="0x13882",!0}catch(t){if(t?.code===4902)try{return await window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:"0x13882",chainName:"Polygon Amoy",rpcUrls:["https://rpc-amoy.polygon.technology"],nativeCurrency:{name:"POL",symbol:"POL",decimals:18},blockExplorerUrls:["https://amoy.polygonscan.com"]}]}),y.value="0x13882",!0}catch{}return!1}}const T="http://localhost:3001".replace(/\/+$/,""),v=d([]),k=d(!1),g=d(""),U=E(()=>(v.value||[]).map(t=>{const e=(t.kind||"").toLowerCase();let a=e.toUpperCase();e==="topup"?a="TOP UP":e==="purchase"?a="PURCHASE":e==="withdraw"?a="WITHDRAW":e==="refund"&&(a="REFUND");let s="OUT",l=0;return e==="purchase"?(l=typeof t.amount_pol=="number"&&!Number.isNaN(t.amount_pol)?t.amount_pol:0,s="OUT"):(l=Math.abs(Number(t.amount)||0),s="IN"),{...t,label:a,direction:s,amountPol:l}}));async function N(t,e){const a=t.startsWith("http")?t:`${T}${t}`,s={...e?.headers||{},"x-wallet-address":c.value.toLowerCase()};e?.body&&!(e.body instanceof FormData)&&(s["Content-Type"]="application/json");const l=await fetch(a,{...e,headers:s}),r=await l.text().catch(()=>"");let u=null;try{u=r?JSON.parse(r):null}catch{u={message:r}}if(!l.ok)throw new Error(u?.error||u?.message||"Request failed");return u}async function C(){if(g.value="",!c.value){v.value=[];return}try{k.value=!0;const t=await N("/transactions"),e=Array.isArray(t)?t:[];v.value=e,await O(e)}catch(t){g.value=String(t?.message||t)}finally{k.value=!1}}async function O(t){if(!w||!o.value)return;const e=[...new Set((t||[]).filter(a=>(a.kind||"").toLowerCase()==="purchase"&&a.tx_hash).map(a=>a.tx_hash))];for(const a of e)try{const l=(await window.ethereum.request({method:"eth_getTransactionByHash",params:[a]}))?.value;if(!l)continue;const r=L(l);t.forEach(u=>{u.tx_hash===a&&(u.amount_pol=r)})}catch(s){console.warn("[wallet] gagal ambil tx dari chain",a,s)}}let _=null;function I(){P(),c.value&&(_=ae(T,{transports:["websocket"],auth:{address:c.value.toLowerCase()}}),_.on("tx:new",async t=>{!t||!t.id||(t.wallet||"").toLowerCase()===c.value.toLowerCase()&&v.value.findIndex(e=>e.id===t.id)===-1&&(v.value.unshift(t),(t.kind||"").toLowerCase()==="purchase"&&await O([t]))}))}function P(){_?.disconnect?.(),_=null}async function V(t){try{await N("/topup",{method:"POST",body:JSON.stringify({amount:Number(t.toFixed(6))})}),_||await C()}catch(e){console.warn("recordTopupDelta failed:",e)}}async function x(){if(!w||!o.value){b.value=0,i.value=null;return}try{const t=await window.ethereum.request({method:"eth_getBalance",params:[o.value,"latest"]}),e=L(t);if(b.value=e,i.value===null)i.value=e;else{const a=e-i.value;a>1e-6?(await V(a),i.value=e):a<-1e-6&&(i.value=e)}}catch{b.value=0}}async function H(){if(w)try{const[t]=await window.ethereum.request({method:"eth_accounts"});o.value=t||"",y.value=await window.ethereum.request({method:"eth_chainId"}).catch(()=>""),o.value&&await W(),await x(),o.value&&(await C(),I())}catch{}}function M(){o.value&&(navigator.clipboard.writeText(o.value),alert("Copied."))}function A(t){o.value=t?.[0]||"",i.value=null,x(),o.value?(C(),I()):(v.value=[],P())}function D(t){y.value=t||"",i.value=null,x()}function J(){const t=window.open(F,"_blank","noopener,noreferrer");if(!t||t.closed||typeof t.closed>"u"){const e=document.createElement("a");e.href=F,e.target="_blank",e.rel="noopener noreferrer",e.style.display="none",document.body.appendChild(e),e.click(),e.remove()}}let S=null;return Y(async()=>{await H(),w&&(window.ethereum.on?.("accountsChanged",A),window.ethereum.on?.("chainChanged",D)),S=window.setInterval(x,15e3)}),G(()=>{w&&(window.ethereum.removeListener?.("accountsChanged",A),window.ethereum.removeListener?.("chainChanged",D)),S&&clearInterval(S),P()}),(t,e)=>(m(),h("div",{class:te(["wallet-page",{"has-sb":f.value}])},[n("header",{class:"topbar"},[e[2]||(e[2]=n("div",{class:"brand"},[n("img",{src:Q,alt:"Tickety"})],-1)),e[3]||(e[3]=n("h1",{class:"title"},"Wallet",-1)),n("button",{class:"hamburger",type:"button","aria-label":"Toggle sidebar",onClick:R},[...e[1]||(e[1]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])]),K(X,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=a=>f.value=a)},null,8,["modelValue"]),n("div",oe,[n("section",se,[n("section",le,[n("div",null,[n("div",re,p(b.value.toLocaleString("en-US",{maximumFractionDigits:6}))+" "+p(xe),1),e[4]||(e[4]=n("div",{class:"muted",style:{"margin-top":"4px"}},"Network: Polygon (PoS)",-1)),n("div",ie,[n("span",{title:c.value},p($(c.value)||"-"),9,ce)]),n("div",ue,[n("button",{class:"btn",onClick:J},"TOP UP"),n("button",{class:"btn ghost",disabled:!c.value,onClick:M},"COPY ADDRESS",8,de)])])]),e[7]||(e[7]=n("hr",{class:"sep"},null,-1)),n("section",null,[e[6]||(e[6]=n("h3",{class:"h-sub"},"Transaction",-1)),g.value?(m(),h("div",he,p(g.value),1)):k.value?(m(),h("div",pe,"Loading…")):(m(),h("ul",me,[(m(!0),h(Z,null,ee(U.value,a=>(m(),h("li",{key:a.id,class:"tx-item"},[n("div",fe,[n("span",we,p(a.label),1),n("span",ve,p(a.direction==="OUT"?"-":"+")+" "+p(a.amountPol.toFixed(6))+" POL ",1)]),n("div",ye,[n("span",_e,p(new Date(a.created_at).toLocaleString("id-ID")),1),a.tx_hash?(m(),h("a",{key:0,href:`https://amoy.polygonscan.com/tx/${a.tx_hash}`,target:"_blank",rel:"noopener noreferrer",class:"tx-link"}," Lihat di PolygonScan ",8,be)):B("",!0)])]))),128)),U.value.length?B("",!0):(m(),h("li",ge,[...e[5]||(e[5]=[n("span",{class:"tx-amount"},"–",-1),n("span",{class:"tx-date"},null,-1)])]))]))])])])],2))}},Se=j(ke,[["__scopeId","data-v-00e556ef"]]);export{Se as default};
